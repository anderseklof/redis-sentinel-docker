# Redis Sentinel Docker

Repository for running Redis with replication and high availability with Sentinel locally in Docker.

## Docker

- Ubuntu 22.04 LTS.
- Redis based on `redis-stack-server`.
- `RediSearch` and `RedisJSON` modules are loaded.

Docker commands:

- Build: `docker build --no-cache --progress=plain -t redis-ubuntu .`
  - `--no-cache` forces rebuild.
  - `--progress-plain` logs output to `stdout`.
- Run: `docker compose up -d`
- View logs: `docker logs <CONTAINER>`
- Connect to container: `docker exec -it <CONTAINER> bash`

## Redis

- Authentication setup:
  - User `default` with `nopass` is disabled.
  - An admin user (`admin`) with full permissions is created in all instances for administrative purposes.
  - Replication: All Redis instances communicate with each other with a user configured with `masteruser` and a password configured with `masterauth`. All Redis instances must have a user with the following permissions: `+psync +replconf +ping`.
  - HA with Sentinel: Communication to and from Sentinels have three scenarios:
    - Sentinel -> Redis: This communication is configured with `sentinel auth-user mymaster` and `sentinel auth-pass mymaster`. All Redis instances must have a user with the following permissions: `allchannels +multi +slaveof +ping +exec +subscribe +config|rewrite +role +publish +info +client|setname +client|kill +script|kill`.
    - Sentinel -> Sentinel: This communication is configured with `sentinel sentinel-user` and `sentinel sentinel-pass`. There are no information of the permissions needed for this user other than full permissions. All Sentinel instances must have a user with full permissions: `allchannels +@all`.
    - Client -> Sentinel: This communication is used between the client and Sentinel. All Sentinel instance must have a user with the following permissions: `-@all +auth +client|getname +client|id +client|setname +command +hello +ping +role +sentinel|get-master-addr-by-name +sentinel|master +sentinel|myid +sentinel|replicas +sentinel|sentinels`
- Replication is enabled.
- 1 master, 2 slaves, 3 Sentinels.
- Static IP addresses and not hostnames. Clients outside of Docker network can't use hostnames.
- Set unique ports to allow back channel communication.
- Includes a network that is `attachable` so that it can be used from other containers. In the other containers add the following:
  - Add top-level `networks` to find `redisnet` network:
    ```yaml
    networks:
      redisnet:
        name: redisnet
    ```
  - Add service level `networks` to set the IP-address for the container:
    ```yaml
    networks:
      redisnet:
        ipv4_address: 192.168.55.30
    ```

## Configuration pain

When you configure a larger system with multiple nodes and instances and using both the configuration file and runtime configuration, you soon learn that there are a certain amount of pain involved in all of this. There are many configurations that need to be correct and the configuration process is made more difficult than it need to be because of differences in syntax and behaviour for the same feature between Redis and Sentinel. Examples:

- Configuration:
  - Redis has `config set`, Sentinel has `sentinel config set` and `sentinel set`. Why use different syntax?
  - When configuring parameters in Redis through configuration file, you use `<PARAMETER> <VALUE>` and when doing it in runtime you use `set <PARAMETER> <VALUE>`. This feels intuitive.
  - If you want to reconfigure `auth-user` in Sentinel you use `sentinel auth-user <MASTER> <USERNAME>` in configuration file and `sentinel set <MASTER> auth-user <USERNAME>` in runtime. Why are values rearranged between configuration and runtime?
  - If you want to reconfigure `sentinel-user` in Sentinel you use `sentinel sentinel-user <USERNAME>` in configuration file and `sentinel config set sentinel-user <USERNAME>` in runtime. Here are values not rearranged.
  - Some permission errors are silent that is very difficult to debug.
- Writing configurations to disk:
  - Redis has `config rewrite` and Sentinel has `sentinel flushconfig`. Why use different syntax?
  - When running `sentinel flushconfig` to write to file, the configurations are written with a comment that says "Generated by CONFIG REWRITE", but that is not correct.
  - For Sentinel, some of the runtime configurations are automatically written to configuration file, but not all. Why is this, why not be consistent with Redis?
  - Most of the rewritten configurations get quoted ("") from Redis but only some from Sentinel. Why is only some configurations quoted and why the difference between Redis and Sentinel?

The pain to configure the system could be a lot smaller if commands, configuration syntax and behaviour was as standardized as possible between systems.

## Redis and Sentinel "good to know"

- Replication does not replicate ACL or configurations. Configurations must be applied to all Redis instances where needed.
- Persist configuration that has been updated at runtime:
  - Redis: You need to run `config rewrite`. `config rewrite` writes the updated configuration to the configuration file.
  - Sentinel: Sentinel automatically writes some of the configuration changes to disk. To be sure that all changes are persisted, run `sentinel flushconfig`.
- If you want to configure Sentinel at runtime, remember to connect to the Sentinel instance port and not the Redis instance port.
- Sentinel configuration has two flavours; standard configuration and global configuration. The standard configuration API at runtime uses `sentinel set` command and the global configuration API uses the `sentinel config set` command. Note that the syntax for setting the configuration in the configuration file is `sentinel <COMMAND> <PARAMETERS>` for both APIs.
- If you get connection error like `ECONNRESET` or `ECONNABORTED`, check that:
  - Username and passwords are correctly configured.
  - If you use ACL: verify that the users has been created with the right permissions.
  - Protected mode in destination instance is disabled; `protected-mode no`.
- Sentinel needs write permission to the folder where the configuration file resides to be able to write temporary files and update the configuration file. If these permissions are missing, one or many of the following errors are written to the Sentinel log file:
  - `Could not create tmp config file (Permission denied)`.
  - `WARNING: Sentinel was not able to save the new configuration on disk!!!: Permission denied`
  - `Sentinel config file /etc/redis/sentinel.conf is not writable: Permission denied. Exiting...`
- When using Docker and mounting local files in `volumes`, verify that you not reuse the same resources between Sentinel services. If two services try to access the same file, the following errors are written to the Sentinel log file:
  - `Could not rename tmp config file (Device or resource busy)`
  - `WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy`
