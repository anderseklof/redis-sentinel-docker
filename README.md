# Redis Sentinel Docker

Repository for running Redis with replication and high availability with Sentinel locally in Docker.

## Docker

- Ubuntu 22.04 LTS.
- Redis based on `redis-stack-server`.
- `RediSearch` and `RedisJSON` modules are loaded.

Docker commands:

- Build: `docker build --no-cache --progress=plain -t redis-ubuntu .`
  - `--no-cache` forces rebuild.
  - `--progress-plain` logs output to `stdout`.
- Run: `docker compose up -d`
- View logs: `docker logs <CONTAINER>`
- Connect to container: `docker exec -it <CONTAINER> bash`

## Redis

- Authentication setup:
  - User `default` with `nopass` is disabled.
  - An admin user (`admin`) with full permissions is created in all instances for administrative purposes.
  - Replication: All Redis instances communicate with each other with a user configured with `masteruser` and a password configured with `masterauth`. All Redis instances must have a user with the following permissions: `+psync +replconf +ping`.
  - HA: The Sentinels communicate in two ways; with the Redis instances and with each other.
    - Sentinel -> Redis: This communication is configured with `sentinel auth-user mymaster` and `sentinel auth-pass mymaster`. All Redis instances must have a user with the following permissions: `allchannels +multi +slaveof +ping +exec +subscribe +config|rewrite +role +publish +info +client|setname +client|kill +script|kill`.
    - Sentinel -> Sentinel: This communication is configured with `sentinel sentinel-user` and `sentinel sentinel-pass`. All Sentinel instances must have a user with the following permissions: `-@all +auth +client|getname +client|id +client|setname +command +hello +ping +role +sentinel|get-master-addr-by-name +sentinel|master +sentinel|masters +sentinel|myid +sentinel|replicas +sentinel|sentinels`.
- Replication is enabled.
- 1 master, 2 slaves, 3 Sentinels.
- Static IP addresses and not hostnames. Clients outside of Docker network can't use hostnames.
- Set unique ports to allow back channel communication.
- Includes a network that is `attachable` so that it can be used from other containers. In the other containers add the following:
  - Add top-level `networks` to find `redisnet` network:
    ```yaml
    networks:
      redisnet:
        name: redisnet
    ```
  - Add service level `networks` to set the IP-address for the container:
    ```yaml
    networks:
      redisnet:
        ipv4_address: 192.168.55.30
    ```

## Configuration pain

When you configure a larger system with multiple nodes and instances and using both the conf file and runtime configuration, you soon learn that there are a certain amount of pain involved in all of this. There are many configurations that needs to be correct and the configuration process is made more difficult than it need to be because of differences in syntax and behaviour for the same feature between Redis and Sentinel. Examples:

- Configuration:
  - Redis has `config set`, Sentinel has `sentinel config set` and `sentinel set`. Why use different syntax?
  - When configuring parameters in Redis through conf file, you use `<PARAMETER> <VALUE>` and when doing it in runtime you use `set <PARAMETER> <VALUE>`. This feels intuitive.
  - If you want to reconfigure `auth-user` in Sentinel you use `sentinel auth-user <MASTER> <USERNAME>` in conf file and `sentinel set <MASTER> auth-user <USERNAME>` in runtime. Why are values rearranged between conf and runtime?
  - If you want to reconfigure `sentinel-user` in Sentinel you use `sentinel sentinel-user <USERNAME>` in conf file and `sentinel config set sentinel-user <USERNAME>` in runtime. Here are not values rearranged.
- Writing configurations to disk:
  - Redis has `config rewrite` and Sentinel has `sentinel flushconfig`. Why use different syntax?
  - When running `sentinel flushconfig` to write to file, the configurations are written with a comment that says "Generated by CONFIG REWRITE", but that is not correct.
  - For Sentinel, some of the runtime configurations are automatically written to conf file, but not all. Why is this, why not be consistent with Redis?
  - Most of the rewritten configurations get quoted ("") from Redis but only some from Sentinel. Why is only some configurations quoted and why the difference between Redis and Sentinel?

And so on... The pain to configure the system could be a lot smaller if commands, configuration syntax and behaviour was as standardized as possible between systems. Another thing that would ease the configuration pain is more verbose logging in the log files.

## Redis and Sentinel "good to know"

- Replication does not replicate ACL or configurations. This rule goes for both Redis and Sentinel. Configurations must be applied to all instances where needed.
- Persist configuration that has changed at runtime:
  - Redis: You need to run `config rewrite`. `config rewrite` writes the updated configuration to the conf file.
  - Sentinel: Sentinel writes the configuration to disk every time something changes in its state. Although that is true for most states, some changes are not saved to disk, eg: disabling user `default`. To be sure that all changes are persisted, run `sentinel flushconfig`.
- If you want to configure Sentinel at runtime, remember to connect to the Sentinel instance port and not the Redis instance port.
- Sentinel configuration has two flavours; standard configuration and global configuration. The standard configuration API uses `sentinel set` command and the global configuration API uses the `sentinel config set` command.
- If you get connection error like `ECONNRESET` or `ECONNABORTED`, check that:
  - Username and passwords are correctly configured.
  - Protected mode in destination instance is disabled; `protected-mode no`.
- Sentinel needs write permission to the folder where the configuration file resides to be able to write temp files.
